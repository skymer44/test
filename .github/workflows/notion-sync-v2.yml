name: ğŸµ Notion Sync - Programme Musical 2026 (Nouvelle Architecture)

on:
  # DÃ©clenchement manuel via l'interface GitHub
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type de synchronisation'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - test
      
  # DÃ©clenchement programmÃ© (2x par jour aux horaires optimaux)
  schedule:
    - cron: '30 6,22 * * *'     # 6h30 (matin) et 22h30 (aprÃ¨s rÃ©pÃ©tition)

  # DÃ©clenchement automatique sur TOUS les push + modifications scripts
  push:
    branches: [ main ]  # Sur tous les commits de la branche principale

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # NÃ©cessaire pour commit et push
      
    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci || npm install
          
      - name: ğŸ¯ Sync Notion data (Data Only)
        env:
          NOTION_TOKEN: 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
          SYNC_TYPE: ${{ github.event.inputs.sync_type || 'full' }}
        run: |
          echo "ğŸš€ Synchronisation des donnÃ©es Notion..."
          echo "ğŸ“Š Type de sync: $SYNC_TYPE"
          node scripts/notion-sync.js
          
      - name: ğŸ—ï¸ Build site with new architecture
        run: |
          echo "ğŸ”„ Construction du site avec nouvelle architecture..."
          npm run build
          echo "âœ… Site construit dans /build/ avec sÃ©paration code/donnÃ©es"
          
      - name: ğŸš€ Deploy to production
        run: |
          echo "ğŸ“ DÃ©ploiement intelligent..."
          npm run deploy
          
      - name: ğŸ“Š Summary Report
        run: |
          echo "ğŸ“Š === RAPPORT DE SYNCHRONISATION V2 ==="
          echo "ğŸ“… Date: $(TZ='Europe/Paris' date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸ¯ Horaires personnalisÃ©s: 6h30 (rÃ©veil) et 22h30 (post-rÃ©pÃ©tition)"
          echo "ğŸ—ï¸ Architecture: Code/DonnÃ©es sÃ©parÃ©es"
          
          # VÃ©rifier si des changements ont Ã©tÃ© faits
          if [ -n "$(git status --porcelain)" ]; then
            echo "âœ… Synchronisation rÃ©ussie avec changements"
            
            # Statistiques
            if [ -f "data/pieces.json" ]; then
              PIECES=$(jq '.pieces | length' data/pieces.json 2>/dev/null || echo "0")
              echo "ğŸµ PiÃ¨ces synchronisÃ©es: $PIECES"
            fi
            
            echo "ğŸ”„ FrÃ©quence optimisÃ©e: 2x/jour (6h30 et 22h30) + Ã  chaque commit"
            echo "ğŸ›¡ï¸ Code protÃ©gÃ© dans /src/ - jamais Ã©crasÃ© par Notion"
          else
            echo "â„¹ï¸ Aucun changement dÃ©tectÃ© - donnÃ©es Ã  jour"
          fi
          
          echo "ğŸŒ Site: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo "ğŸ“ Structure:"
          echo "  /src/     â†’ Code source (protÃ©gÃ©)"
          echo "  /data/    â†’ DonnÃ©es Notion (auto-sync)"
          echo "  /build/   â†’ Site gÃ©nÃ©rÃ© (auto-build)"
          echo "========================================="
