name: üéµ Notion Sync pour Netlify - Programme Musical 2026

on:
  # D√©clenchement manuel via l'interface GitHub
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type de synchronisation'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - test
      
  # D√©clenchement programm√© (2x par jour aux horaires optimaux)
  schedule:
    - cron: '30 6,22 * * *'     # 6h30 (matin) et 22h30 (apr√®s r√©p√©tition)

  # D√©clenchement automatique sur modifications des scripts Notion
  push:
    branches: [ main ]
    paths:
      - 'scripts/notion-*.js'
      - 'scripts/smart-mapper.js'
      - 'data/**'

jobs:
  sync-data-only:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # N√©cessaire pour commit et push
      
    steps:
      - name: üîÑ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: üì¶ Install dependencies
        run: |
          npm ci || npm install
          
      - name: üéØ Sync Notion data (JSON uniquement)
        env:
          NOTION_TOKEN: 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
          SYNC_TYPE: ${{ github.event.inputs.sync_type || 'full' }}
        run: |
          echo "üöÄ Synchronisation des donn√©es Notion vers JSON..."
          echo "üìä Type de sync: $SYNC_TYPE"
          echo "üéØ Architecture: Donn√©es JSON uniquement, pas de modification HTML"
          node scripts/notion-sync.js
          
      - name: üîÑ Commit et Push des donn√©es
        run: |
          echo "ÔøΩ Commit des donn√©es JSON uniquement..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action - Notion Sync"
          
          # V√©rifier s'il y a des changements dans le dossier data
          if git diff --quiet HEAD -- data/; then
            echo "‚ÑπÔ∏è Aucun changement dans les donn√©es Notion"
          else
            git add data/
            git commit -m "üéµ Sync Notion data [$(TZ='Europe/Paris' date '+%Y-%m-%d %H:%M')]"
            git push
            echo "‚úÖ Donn√©es Notion mises √† jour et d√©ploy√©es sur Netlify"
          fi
          
      - name: üìä Rapport de synchronisation
        run: |
          echo "üìä === RAPPORT SYNC NETLIFY ==="
          echo "üìÖ Date: $(TZ='Europe/Paris' date +'%Y-%m-%d %H:%M:%S')"
          echo "üéØ D√©ploiement: Netlify uniquement"
          echo "ÔøΩ Site production: https://fichemusicien.site"
          echo "üîÑ Fr√©quence: 2x/jour (6h30 et 22h30) + manuel"
          echo ""
          
          # Statistiques des donn√©es
          if [ -f "data/pieces.json" ]; then
            PIECES=$(jq '.pieces | length' data/pieces.json 2>/dev/null || echo "0")
            echo "üéµ Pi√®ces synchronis√©es: $PIECES"
          fi
          
          if [ -f "data/concerts.json" ]; then
            CONCERTS=$(jq '.concerts | length' data/concerts.json 2>/dev/null || echo "0")
            echo "üé≠ Concerts synchronis√©s: $CONCERTS"
          fi
          
          if [ -f "data/events.json" ]; then
            EVENTS=$(jq '.events | length' data/events.json 2>/dev/null || echo "0")
            echo "üóìÔ∏è √âv√©nements synchronis√©s: $EVENTS"
          fi
          
          echo ""
          echo "‚úÖ Architecture s√©curis√©e:"
          echo "  ‚Ä¢ HTML statique pr√©serv√©"
          echo "  ‚Ä¢ Donn√©es JSON dynamiques"
          echo "  ‚Ä¢ D√©ploiement automatique Netlify"
          echo "  ‚Ä¢ Pas de conflit Git"
          echo "================================="
