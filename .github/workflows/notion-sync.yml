name: ğŸµ Notion Sync - Programme Musical 2026

on:
  # DÃ©clenchement manuel via l'interface GitHub
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type de synchronisation'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - test
      
  # DÃ©clenchement programmÃ© (tous les jours Ã  8h et 18h)
  schedule:
    - cron: '0 8,18 * * *'  # 8h00 et 18h00 UTC (10h et 20h en France)

  # DÃ©clenchement sur push (pour tester les modifications du script)
  push:
    paths:
      - 'scripts/notion-sync.js'
      - '.github/workflows/notion-sync.yml'

jobs:
  sync-notion-data:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # NÃ©cessaire pour commit et push
      
    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          npm init -y
          npm install @notionhq/client@latest
          
      - name: ğŸ¯ Sync Notion data
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          SYNC_TYPE: ${{ github.event.inputs.sync_type || 'full' }}
        run: |
          echo "ğŸš€ DÃ©marrage de la synchronisation Notion..."
          echo "ğŸ“Š Type de sync: $SYNC_TYPE"
          node scripts/notion-sync.js
          
      - name: ğŸ“ Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changements dÃ©tectÃ©s"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun changement dÃ©tectÃ©"
          fi
          
      - name: ğŸ’¾ Commit and push changes
        if: steps.changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "ğŸµ Sync automatique depuis Notion - $(date +'%Y-%m-%d %H:%M')"
          git push
          
      - name: ğŸ“Š Summary
        run: |
          if [ "${{ steps.changes.outputs.changes }}" == "true" ]; then
            echo "âœ… Synchronisation rÃ©ussie avec changements appliquÃ©s"
          else
            echo "â„¹ï¸ Synchronisation rÃ©ussie - aucun changement nÃ©cessaire"
          fi
