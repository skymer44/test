name: 🎵 Notion Sync - Programme Musical 2026

on:
  # Déclenchement manuel via l'interface GitHub
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type de synchronisation'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - test
      
  # Déclenchement programmé - synchronisation optimale
  schedule:
    - cron: '*/10 * * * *'     # Toutes les 10 minutes (excellent compromis)

  # Déclenchement sur push (pour tester les modifications du script)
  push:
    paths:
      - 'scripts/notion-sync.js'
      - 'scripts/intelligent-update-site.js'
      - '.github/workflows/notion-sync.yml'

jobs:
  sync-notion-data:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Nécessaire pour commit et push
      
    steps:
      - name: 🔄 Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: 📦 Install dependencies
        run: |
          npm ci || npm install
          
      - name: 🎯 Sync Notion data
        env:
          NOTION_TOKEN: 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
          SYNC_TYPE: ${{ github.event.inputs.sync_type || 'full' }}
        run: |
          echo "🚀 Démarrage de la synchronisation Notion..."
          echo "📊 Type de sync: $SYNC_TYPE"
          node scripts/notion-sync.js
          
      - name: 🌐 Update website
        run: |
          echo "🔄 Mise à jour intelligente du site web..."
          node scripts/intelligent-update-site.js
          echo "✅ Site web mis à jour avec organisation intelligente"
          
      - name: 📝 Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "✅ Changements détectés"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ℹ️ Aucun changement détecté"
          fi
          
      - name: 💾 Commit and push changes
        if: steps.changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action - Notion Sync"
          git add data/ index.html
          
          # Créer un commit avec timestamp français
          TIMESTAMP=$(TZ='Europe/Paris' date +'%Y-%m-%d à %H:%M:%S')
          git commit -m "🎵 Sync automatique depuis Notion - $TIMESTAMP" -m "✨ Données mises à jour depuis les bases Notion"
          git push
          
      - name: 📊 Summary
        run: |
          echo "📊 === RAPPORT DE SYNCHRONISATION ==="
          echo "📅 Date: $(TZ='Europe/Paris' date +'%Y-%m-%d %H:%M:%S')"
          echo "🎯 Type: ${{ github.event.inputs.sync_type || 'full' }}"
          
          if [ "${{ steps.changes.outputs.changes }}" == "true" ]; then
            echo "✅ Synchronisation réussie avec changements appliqués"
            
            # Statistiques
            if [ -f "data/concerts.json" ]; then
              CONCERTS=$(jq '.concerts | length' data/concerts.json 2>/dev/null || echo "0")
              echo "🎭 Concerts: $CONCERTS"
            fi
            
            if [ -f "data/pieces.json" ]; then
              PIECES=$(jq '.pieces | length' data/pieces.json 2>/dev/null || echo "0")
              echo "🎵 Pièces: $PIECES"
            fi
          else
            echo "ℹ️ Synchronisation réussie - aucun changement nécessaire"
          fi
          
          echo "🌐 Site disponible à: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
