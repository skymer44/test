name: ğŸµ Notion Sync - Programme Musical 2026

on:
  # DÃ©clenchement manuel via l'interface GitHub
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type de synchronisation'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - test
      
  # DÃ©clenchement programmÃ© - synchronisation optimale
  schedule:
    - cron: '*/10 * * * *'     # Toutes les 10 minutes (excellent compromis)

  # DÃ©clenchement sur push (pour tester les modifications du script)
  push:
    paths:
      - 'scripts/notion-sync.js'
      - 'scripts/intelligent-update-site.js'
      - '.github/workflows/notion-sync.yml'

jobs:
  sync-notion-data:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # NÃ©cessaire pour commit et push
      
    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci || npm install
          
      - name: ğŸ¯ Sync Notion data
        env:
          NOTION_TOKEN: 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
          SYNC_TYPE: ${{ github.event.inputs.sync_type || 'full' }}
        run: |
          echo "ğŸš€ DÃ©marrage de la synchronisation Notion..."
          echo "ğŸ“Š Type de sync: $SYNC_TYPE"
          node scripts/notion-sync.js
          
      - name: ğŸŒ Update website
        run: |
          echo "ğŸ”„ Mise Ã  jour intelligente du site web..."
          node scripts/intelligent-update-site.js
          echo "âœ… Site web mis Ã  jour avec organisation intelligente"
          
      - name: ğŸ“ Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changements dÃ©tectÃ©s"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun changement dÃ©tectÃ©"
          fi
          
      - name: ğŸ’¾ Commit and push changes
        if: steps.changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action - Notion Sync"
          git add data/ index.html
          
          # CrÃ©er un commit avec timestamp franÃ§ais
          TIMESTAMP=$(TZ='Europe/Paris' date +'%Y-%m-%d Ã  %H:%M:%S')
          git commit -m "ğŸµ Sync automatique depuis Notion - $TIMESTAMP" -m "âœ¨ DonnÃ©es mises Ã  jour depuis les bases Notion"
          git push
          
      - name: ğŸ“Š Summary
        run: |
          echo "ğŸ“Š === RAPPORT DE SYNCHRONISATION ==="
          echo "ğŸ“… Date: $(TZ='Europe/Paris' date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸ¯ Type: ${{ github.event.inputs.sync_type || 'full' }}"
          
          if [ "${{ steps.changes.outputs.changes }}" == "true" ]; then
            echo "âœ… Synchronisation rÃ©ussie avec changements appliquÃ©s"
            
            # Statistiques
            if [ -f "data/concerts.json" ]; then
              CONCERTS=$(jq '.concerts | length' data/concerts.json 2>/dev/null || echo "0")
              echo "ğŸ­ Concerts: $CONCERTS"
            fi
            
            if [ -f "data/pieces.json" ]; then
              PIECES=$(jq '.pieces | length' data/pieces.json 2>/dev/null || echo "0")
              echo "ğŸµ PiÃ¨ces: $PIECES"
            fi
          else
            echo "â„¹ï¸ Synchronisation rÃ©ussie - aucun changement nÃ©cessaire"
          fi
          
          echo "ğŸŒ Site disponible Ã : https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
